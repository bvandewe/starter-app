# Starter App Application - Docker Compose Configuration
# This file is based on the simple-ui sample docker-compose configuration

name: starter-app

services:
    # ðŸ“± Starter App Application
    # http://localhost:${APP_PORT:-8020}/
    # http://localhost:8020/
    app:
        build:
            context: .
            dockerfile: Dockerfile
        command: ['sh', '-c', 'cd /app/src && pip install debugpy -t /tmp && PYTHONPATH=/tmp:/app/src python -m debugpy --listen 0.0.0.0:5678 -m uvicorn main:create_app --factory --host 0.0.0.0 --port 8080 --reload --reload-dir /app/src']
        ports:
            - '${APP_PORT:-8020}:8080' # Main application port
            - '5678:5678' # Debug port
        environment:
            LOCAL_DEV: 'true'
            LOG_LEVEL: DEBUG
            PYTHONPATH: '/app/src'

            # JWT Configuration
            JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-me-in-production}
            JWT_ALGORITHM: HS256
            JWT_EXPIRATION_HOURS: 24

            # Database connections (MongoDB for future use)
            CONNECTION_STRINGS: '{"mongo": "mongodb://root:${MONGODB_PASSWORD:-password123}@mongodb:27017/?authSource=admin"}'

            # Keycloak Configuration (Optional)
            KEYCLOAK_SERVER_URL: http://keycloak:8080
            KEYCLOAK_REALM: ${KEYCLOAK_REALM:-starter-app}
            KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-starter-app-public}
            KEYCLOAK_PORT: ${KEYCLOAK_PORT:-8021}

            # Redis Configuration (Session Storage)
            REDIS_URL: redis://redis:6379/0
            REDIS_ENABLED: ${REDIS_ENABLED:-false} # Set to true to use Redis for sessions
            REDIS_KEY_PREFIX: 'session:'

            # Application settings
            ENABLE_CORS: 'true'

            # Event streaming
            CLOUD_EVENT_SINK: http://event-player:8080/events/pub
            CLOUD_EVENT_SOURCE: https://starter-app.io
            CLOUD_EVENT_TYPE_PREFIX: io.starter-app

            # OpenTelemetry configuration - Metrics & Traces
            OTEL_SERVICE_NAME: starter-app
            OTEL_SERVICE_VERSION: 1.0.0
            OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
            OTEL_EXPORTER_OTLP_PROTOCOL: grpc
            OTEL_TRACES_EXPORTER: otlp
            OTEL_METRICS_EXPORTER: otlp
            OTEL_LOGS_EXPORTER: none
            OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: 'false'
        volumes:
            - ./:/app
        networks:
            - starter-app-net
        depends_on:
            - mongodb
            - keycloak
            - redis
            - ui-builder

    # ðŸ” Keycloak (Authentication & Authorization)
    # http://localhost:${KEYCLOAK_PORT} (admin/admin)
    # http://localhost:8021
    # Shared SSO/OAuth2 server for all samples
    keycloak:
        image: quay.io/keycloak/keycloak:22.0.5
        runtime: runc
        command: ['start-dev', '--import-realm']
        ports:
            - '${KEYCLOAK_PORT:-8021}:8080'
        environment:
            # Admin credentials
            KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USERNAME:-admin}
            KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
            # Development settings (no external DB, uses H2)
            KC_HTTP_PORT: 8080
            KC_HOSTNAME_STRICT: false
            KC_HOSTNAME_STRICT_HTTPS: false
            KC_HTTP_ENABLED: true
            KC_HEALTH_ENABLED: true
            KC_METRICS_ENABLED: true
            # Disable HTTPS requirement for admin console (development only!)
            KC_HOSTNAME_URL: http://localhost:${KEYCLOAK_PORT:-8021}
            KC_HOSTNAME_ADMIN_URL: http://localhost:${KEYCLOAK_PORT:-8021}
            KC_PROXY: edge
        volumes:
            # Persist H2 database to maintain Keycloak configuration across container restarts
            # NOTE: Master realm SSL setting (sslRequired=none) is persisted in this volume
            - keycloak_data:/opt/keycloak/data
            # Import realm configurations on first startup
            - ./deployment/keycloak/starter-app-realm-export.json:/opt/keycloak/data/import/starter-app-realm-export.json:ro
        networks:
            - starter-app-net

    # ðŸ—„ï¸ MongoDB Database
    # mongodb://localhost:${MONGODB_PORT}
    # Shared database server for all samples
    mongodb:
        image: mongo:6.0.21
        restart: always
        runtime: runc
        command: mongod --bind_ip_all
        ports:
            - '${MONGODB_PORT:-8022}:27017'
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-root}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-password123}
            MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-neuroglia}
        volumes:
            - mongodb_data:/data/db
        networks:
            - starter-app-net

    # ðŸ“Š MongoDB Express (Database Admin UI)
    # http://localhost:${MONGODB_EXPRESS_PORT}
    # http://localhost:8023
    # No authentication required (development only!)
    mongo-express:
        image: mongo-express:latest
        restart: always
        ports:
            - '${MONGODB_EXPRESS_PORT:-8023}:8081'
        environment:
            ME_CONFIG_MONGODB_SERVER: mongodb
            ME_CONFIG_MONGODB_PORT: 27017
            ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGODB_ROOT_USERNAME:-root}
            ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGODB_ROOT_PASSWORD:-password123}
            ME_CONFIG_MONGODB_ENABLE_ADMIN: 'true'
            ME_CONFIG_MONGODB_AUTH_DATABASE: admin
            ME_CONFIG_BASICAUTH: 'false'
        networks:
            - starter-app-net
        depends_on:
            - mongodb

    # ðŸŽ¬ Event Player (Event Visualization & Replay)
    # http://localhost:${EVENT_PLAYER_PORT}
    # http://localhost:8024
    # Shared event visualization and replay service for all samples
    event-player:
        image: ghcr.io/bvandewe/events-player:v0.4.11
        runtime: runc
        ports:
            - '${EVENT_PLAYER_PORT:-8024}:8080'
        environment:
            tag: 'v0.4.11'
            log_level: INFO

            # Authentication & Authorization
            auth_required: 'true'
            auth_audience: events-player-web
            auth_algorithm: RS256

            # Role Mapping Configuration
            auth_role_admin: 'admin' # Role name in JWT that grants admin privileges
            auth_role_architect: 'architect' # Role name in JWT that grants architect privileges
            auth_role_manager: 'manager' # Role name in JWT that grants manager privileges
            auth_role_vendor: 'vendor' # Role name in JWT that grants vendor privileges
            auth_role_developer: 'developer' # Role name in JWT that grants developer privileges
            auth_role_user: 'user' # Role name in JWT that grants user privileges

            # OAuth/OIDC Configuration
            # oauth_server_url: URL accessible from browser (external)
            # oauth_server_url_backend: URL accessible from backend container (internal Docker network)
            oauth_server_url: http://localhost:${KEYCLOAK_PORT:-8021}
            oauth_server_url_backend: http://keycloak:8080
            oauth_legacy_keycloak: 'false'
            oauth_realm: ${KEYCLOAK_REALM:-starter-app}
            oauth_client_id: starter-app-public
            oauth_client_secret: ''

            # HTTP Client Configuration
            http_client_timeout: 30.0

            # Default Generator Settings
            default_generator_gateways: '{"urls": ["http://localhost:${EVENT_PLAYER_PORT:-8024}/events/pub", "http://event-player:8080/events/pub", "http://app:8080/events/pub"]}'
            default_generator_event: '{"event_source": "https://dummy.source.com/sys-admin", "event_type": "com.source.dummy.test.requested.v1", "event_subject": "some.interesting.concept.key_abcde12345", "event_data": {"foo": "bar"}}'

            # Frontend Storage Configuration
            browser_queue_size: 1000
            storage_max_recent_events: 5000
            storage_max_metadata_events: 100000
        networks:
            - starter-app-net
        depends_on:
            - keycloak

    # ðŸ”´ Redis (Session Store)
    # redis://localhost:${REDIS_PORT}
    # Distributed session storage for horizontal scaling
    redis:
        image: redis:7.4-alpine
        restart: always
        ports:
            - '${REDIS_PORT:-6379}:6379'
        command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        volumes:
            - redis_data:/data
        networks:
            - starter-app-net
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 10s
            timeout: 3s
            retries: 3

    # ðŸ”­ OpenTelemetry Collector (All-in-One)
    # Receives, processes, and exports telemetry data (traces, metrics, logs)
    # Ports: ${OTEL_COLLECTOR_GRPC_PORT} (OTLP gRPC), ${OTEL_COLLECTOR_HTTP_PORT} (OTLP HTTP)
    otel-collector:
        image: otel/opentelemetry-collector-contrib:0.110.0
        runtime: runc
        command: ['--config=/etc/otel-collector-config.yaml']
        ports:
            - '${OTEL_COLLECTOR_GRPC_PORT:-4317}:4317' # OTLP gRPC receiver
            - '${OTEL_COLLECTOR_HTTP_PORT:-4318}:4318' # OTLP HTTP receiver
            - '${OTEL_COLLECTOR_METRICS_PORT:-8888}:8888' # Prometheus metrics about the collector itself
            - '${OTEL_COLLECTOR_HEALTH_PORT:-13133}:13133' # Health check endpoint
        volumes:
            - ./deployment/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
        networks:
            - starter-app-net

    # ðŸŽ¨ UI Builder (Parcel Watch Mode)
    # Automatically rebuilds UI assets on file changes
    ui-builder:
        image: node:20-alpine
        working_dir: /app/src/ui
        command: npm run watch
        volumes:
            - ./:/app
            - /app/src/ui/node_modules # Anonymous volume for node_modules
        networks:
            - starter-app-net
        environment:
            NODE_ENV: development
        entrypoint: >
            sh -c "
            npm install &&
            npm run watch
            "

networks:
    starter-app-net:
        driver: bridge

volumes:
    mongodb_data:
    keycloak_data:
    redis_data:
